name: Publish npm

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Release tag to publish (vX.Y.Z)"
        required: true
        type: string
      dist_tag:
        description: "npm dist-tag"
        required: true
        default: "latest"
        type: string
      dry_run:
        description: "Run npm publish with --dry-run"
        required: true
        default: true
        type: boolean

permissions:
  contents: read

concurrency:
  group: publish-npm-${{ github.event_name == 'push' && github.ref_name || inputs.release_tag }}
  cancel-in-progress: false

defaults:
  run:
    shell: bash

jobs:
  prepare:
    name: Resolve publish parameters
    runs-on: ubuntu-latest
    outputs:
      release_tag: ${{ steps.resolve.outputs.release_tag }}
      release_ref: ${{ steps.resolve.outputs.release_ref }}
      version: ${{ steps.resolve.outputs.version }}
      dist_tag: ${{ steps.resolve.outputs.dist_tag }}
      dry_run: ${{ steps.resolve.outputs.dry_run }}
    steps:
      - name: Resolve inputs/tag defaults
        id: resolve
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            release_tag="${{ github.ref_name }}"
            dist_tag="latest"
            dry_run="false"
          else
            release_tag="${{ inputs.release_tag }}"
            dist_tag="${{ inputs.dist_tag }}"
            dry_run="${{ inputs.dry_run }}"
          fi

          if ! [[ "${release_tag}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "release_tag must match vX.Y.Z, got: ${release_tag}" >&2
            exit 1
          fi
          if [ -z "${dist_tag}" ]; then
            echo "dist_tag must not be empty" >&2
            exit 1
          fi
          if [ "${dry_run}" != "true" ] && [ "${dry_run}" != "false" ]; then
            echo "dry_run must be true/false, got: ${dry_run}" >&2
            exit 1
          fi

          echo "release_tag=${release_tag}" >> "$GITHUB_OUTPUT"
          echo "release_ref=${release_tag}" >> "$GITHUB_OUTPUT"
          echo "version=${release_tag#v}" >> "$GITHUB_OUTPUT"
          echo "dist_tag=${dist_tag}" >> "$GITHUB_OUTPUT"
          echo "dry_run=${dry_run}" >> "$GITHUB_OUTPUT"

      - name: Summary
        run: |
          echo "- release_tag=${{ steps.resolve.outputs.release_tag }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- version=${{ steps.resolve.outputs.version }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- dist_tag=${{ steps.resolve.outputs.dist_tag }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- dry_run=${{ steps.resolve.outputs.dry_run }}" >> "$GITHUB_STEP_SUMMARY"

  publish-tui:
    name: Publish TUI (${{ matrix.target }})
    runs-on: ${{ matrix.runs_on }}
    needs: prepare
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: darwin-arm64
            runs_on: macos-latest
            platform: darwin
            arch: arm64
            rust_target: aarch64-apple-darwin
            package_dir: packages/tui/darwin-arm64
            binary_name: codelia-tui
          - target: darwin-x64
            runs_on: macos-latest
            platform: darwin
            arch: x64
            rust_target: x86_64-apple-darwin
            package_dir: packages/tui/darwin-x64
            binary_name: codelia-tui
          - target: linux-arm64
            runs_on: ubuntu-22.04
            platform: linux
            arch: arm64
            rust_target: aarch64-unknown-linux-gnu
            package_dir: packages/tui/linux-arm64
            binary_name: codelia-tui
          - target: linux-x64
            runs_on: ubuntu-22.04
            platform: linux
            arch: x64
            rust_target: x86_64-unknown-linux-gnu
            package_dir: packages/tui/linux-x64
            binary_name: codelia-tui
          - target: win32-x64
            runs_on: windows-latest
            platform: win32
            arch: x64
            rust_target: x86_64-pc-windows-msvc
            package_dir: packages/tui/win32-x64
            binary_name: codelia-tui.exe
    env:
      RELEASE_TAG: ${{ needs.prepare.outputs.release_tag }}
      RELEASE_VERSION: ${{ needs.prepare.outputs.version }}
      PUBLISH_DIST_TAG: ${{ needs.prepare.outputs.dist_tag }}
      PUBLISH_DRY_RUN: ${{ needs.prepare.outputs.dry_run }}

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.release_ref }}

      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          registry-url: "https://registry.npmjs.org"

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rust_target }}

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: crates/tui
          shared-key: publish-${{ matrix.target }}

      - name: Install Linux arm64 cross toolchain
        if: ${{ matrix.target == 'linux-arm64' }}
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Build TUI binary
        run: |
          if [ "${{ matrix.target }}" = "linux-arm64" ]; then
            export CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc
          fi
          cargo build --release --manifest-path crates/tui/Cargo.toml --target "${{ matrix.rust_target }}"

      - name: Check Linux GLIBC compatibility
        if: ${{ matrix.platform == 'linux' }}
        run: |
          binary_path="crates/tui/target/${{ matrix.rust_target }}/release/${{ matrix.binary_name }}"
          max_glibc="$(strings "${binary_path}" | grep -Eo 'GLIBC_[0-9]+\.[0-9]+' | sort -V | tail -n1)"
          max_allowed="GLIBC_2.35"
          if [ -n "${max_glibc}" ] && [ "$(printf '%s\n%s\n' "${max_glibc}" "${max_allowed}" | sort -V | tail -n1)" != "${max_allowed}" ]; then
            echo "Binary requires ${max_glibc}, which is newer than allowed ${max_allowed}" >&2
            exit 1
          fi
          echo "GLIBC compatibility check passed: ${max_glibc:-none-detected} (allowed <= ${max_allowed})"

      - name: Stage TUI package binary
        run: |
          node scripts/stage-tui-binary.mjs \
            --platform "${{ matrix.platform }}" \
            --arch "${{ matrix.arch }}" \
            --source "crates/tui/target/${{ matrix.rust_target }}/release/${{ matrix.binary_name }}"

      - name: Resolve package metadata
        id: meta
        run: |
          pkg_name="$(node -p "require('./${{ matrix.package_dir }}/package.json').name")"
          pkg_version="$(node -p "require('./${{ matrix.package_dir }}/package.json').version")"
          if [ "${pkg_version}" != "${RELEASE_VERSION}" ]; then
            echo "${pkg_name} version ${pkg_version} does not match release tag ${RELEASE_TAG} (${RELEASE_VERSION})" >&2
            exit 1
          fi
          echo "name=${pkg_name}" >> "$GITHUB_OUTPUT"
          echo "version=${pkg_version}" >> "$GITHUB_OUTPUT"
          if npm view "${pkg_name}@${pkg_version}" version >/dev/null 2>&1; then
            echo "already_published=true" >> "$GITHUB_OUTPUT"
            echo "- ${pkg_name}@${pkg_version}: already published, skip" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "already_published=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Validate npm token
        if: ${{ env.PUBLISH_DRY_RUN != 'true' && steps.meta.outputs.already_published != 'true' }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          if [ -z "${NODE_AUTH_TOKEN:-}" ]; then
            echo "NPM_TOKEN secret is required when dry_run=false" >&2
            exit 1
          fi

      - name: Publish TUI package
        if: ${{ steps.meta.outputs.already_published != 'true' }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          cd "${{ matrix.package_dir }}"
          if [ "${PUBLISH_DRY_RUN}" = "true" ]; then
            npm publish --access public --dry-run --tag "${PUBLISH_DIST_TAG}"
          else
            npm publish --access public --tag "${PUBLISH_DIST_TAG}"
          fi

  publish-ts:
    name: Publish TypeScript packages
    runs-on: ubuntu-latest
    needs: [prepare, publish-tui]
    env:
      RELEASE_TAG: ${{ needs.prepare.outputs.release_tag }}
      RELEASE_VERSION: ${{ needs.prepare.outputs.version }}
      PUBLISH_DIST_TAG: ${{ needs.prepare.outputs.dist_tag }}
      PUBLISH_DRY_RUN: ${{ needs.prepare.outputs.dry_run }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.release_ref }}

      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          registry-url: "https://registry.npmjs.org"

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.9"

      - name: Install
        run: bun install --frozen-lockfile

      - name: Build JS packages
        run: bun run --filter @codelia/* build

      - name: Validate npm token
        if: ${{ env.PUBLISH_DRY_RUN != 'true' }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          if [ -z "${NODE_AUTH_TOKEN:-}" ]; then
            echo "NPM_TOKEN secret is required when dry_run=false" >&2
            exit 1
          fi

      - name: Publish TypeScript packages in dependency order
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          package_dirs=(
            packages/config
            packages/logger
            packages/shared-types
            packages/protocol
            packages/core
            packages/storage
            packages/config-loader
            packages/model-metadata
            packages/runtime
            packages/cli
          )

          for dir in "${package_dirs[@]}"; do
            pkg_name="$(node -p "require('./${dir}/package.json').name")"
            pkg_version="$(node -p "require('./${dir}/package.json').version")"

            if [ "${pkg_version}" != "${RELEASE_VERSION}" ]; then
              echo "${pkg_name} version ${pkg_version} does not match release tag ${RELEASE_TAG} (${RELEASE_VERSION})" >&2
              exit 1
            fi

            if npm view "${pkg_name}@${pkg_version}" version >/dev/null 2>&1; then
              echo "- ${pkg_name}@${pkg_version}: already published, skip" >> "$GITHUB_STEP_SUMMARY"
              continue
            fi

            echo "Publishing ${pkg_name}@${pkg_version} from ${dir}"
            if [ "${PUBLISH_DRY_RUN}" = "true" ]; then
              (cd "${dir}" && npm publish --access public --dry-run --tag "${PUBLISH_DIST_TAG}")
            else
              (cd "${dir}" && npm publish --access public --tag "${PUBLISH_DIST_TAG}")
            fi
          done
