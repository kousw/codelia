name: Publish npm

on:
  workflow_dispatch:
    inputs:
      dist_tag:
        description: "npm dist-tag"
        required: true
        default: "latest"
        type: string
      dry_run:
        description: "Run npm publish with --dry-run"
        required: true
        default: true
        type: boolean

permissions:
  contents: read

concurrency:
  group: publish-npm-${{ github.ref }}
  cancel-in-progress: false

defaults:
  run:
    shell: bash

jobs:
  publish-tui:
    name: Publish TUI (${{ matrix.target }})
    runs-on: ${{ matrix.runs_on }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: darwin-arm64
            runs_on: macos-14
            platform: darwin
            arch: arm64
            rust_target: aarch64-apple-darwin
            package_dir: packages/tui/darwin-arm64
            binary_name: codelia-tui
          - target: darwin-x64
            runs_on: macos-13
            platform: darwin
            arch: x64
            rust_target: x86_64-apple-darwin
            package_dir: packages/tui/darwin-x64
            binary_name: codelia-tui
          - target: linux-arm64
            runs_on: ubuntu-24.04-arm
            platform: linux
            arch: arm64
            rust_target: aarch64-unknown-linux-gnu
            package_dir: packages/tui/linux-arm64
            binary_name: codelia-tui
          - target: linux-x64
            runs_on: ubuntu-latest
            platform: linux
            arch: x64
            rust_target: x86_64-unknown-linux-gnu
            package_dir: packages/tui/linux-x64
            binary_name: codelia-tui
          - target: win32-x64
            runs_on: windows-latest
            platform: win32
            arch: x64
            rust_target: x86_64-pc-windows-msvc
            package_dir: packages/tui/win32-x64
            binary_name: codelia-tui.exe

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          registry-url: "https://registry.npmjs.org"

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rust_target }}

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: crates/tui
          shared-key: publish-${{ matrix.target }}

      - name: Build TUI binary
        run: cargo build --release --manifest-path crates/tui/Cargo.toml --target ${{ matrix.rust_target }}

      - name: Stage TUI package binary
        run: |
          node scripts/stage-tui-binary.mjs \
            --platform "${{ matrix.platform }}" \
            --arch "${{ matrix.arch }}" \
            --source "crates/tui/target/${{ matrix.rust_target }}/release/${{ matrix.binary_name }}"

      - name: Resolve package metadata
        id: meta
        run: |
          pkg_name="$(node -p "require('./${{ matrix.package_dir }}/package.json').name")"
          pkg_version="$(node -p "require('./${{ matrix.package_dir }}/package.json').version")"
          echo "name=${pkg_name}" >> "$GITHUB_OUTPUT"
          echo "version=${pkg_version}" >> "$GITHUB_OUTPUT"
          if npm view "${pkg_name}@${pkg_version}" version >/dev/null 2>&1; then
            echo "already_published=true" >> "$GITHUB_OUTPUT"
            echo "- ${pkg_name}@${pkg_version}: already published, skip" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "already_published=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Validate npm token
        if: ${{ !inputs.dry_run && steps.meta.outputs.already_published != 'true' }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          if [ -z "${NODE_AUTH_TOKEN:-}" ]; then
            echo "NPM_TOKEN secret is required when dry_run=false" >&2
            exit 1
          fi

      - name: Publish TUI package
        if: ${{ steps.meta.outputs.already_published != 'true' }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          cd "${{ matrix.package_dir }}"
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            npm publish --access public --dry-run --tag "${{ inputs.dist_tag }}"
          else
            npm publish --access public --tag "${{ inputs.dist_tag }}"
          fi

  publish-ts:
    name: Publish TypeScript packages
    runs-on: ubuntu-latest
    needs: publish-tui
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          registry-url: "https://registry.npmjs.org"

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.9"

      - name: Install
        run: bun install --frozen-lockfile

      - name: Build JS packages
        run: bun run --filter @codelia/* build

      - name: Validate npm token
        if: ${{ !inputs.dry_run }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          if [ -z "${NODE_AUTH_TOKEN:-}" ]; then
            echo "NPM_TOKEN secret is required when dry_run=false" >&2
            exit 1
          fi

      - name: Publish TypeScript packages in dependency order
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          package_dirs=(
            packages/config
            packages/logger
            packages/shared-types
            packages/protocol
            packages/core
            packages/storage
            packages/config-loader
            packages/model-metadata
            packages/runtime
            packages/cli
          )

          for dir in "${package_dirs[@]}"; do
            pkg_name="$(node -p "require('./${dir}/package.json').name")"
            pkg_version="$(node -p "require('./${dir}/package.json').version")"

            if npm view "${pkg_name}@${pkg_version}" version >/dev/null 2>&1; then
              echo "- ${pkg_name}@${pkg_version}: already published, skip" >> "$GITHUB_STEP_SUMMARY"
              continue
            fi

            echo "Publishing ${pkg_name}@${pkg_version} from ${dir}"
            if [ "${{ inputs.dry_run }}" = "true" ]; then
              (cd "${dir}" && npm publish --access public --dry-run --tag "${{ inputs.dist_tag }}")
            else
              (cd "${dir}" && npm publish --access public --tag "${{ inputs.dist_tag }}")
            fi
          done
